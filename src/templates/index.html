<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local RAG Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="ragApp()" x-cloak>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Local RAG Assistant</h1>
                    <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">v1.0.0</span>
                </div>
                
                <!-- Status Indicators -->
                <div class="flex items-center space-x-4">
                    <!-- RAG Model Status -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">RAG:</span>
                        <span 
                            class="px-2 py-1 text-xs rounded-full"
                            :class="{
                                'bg-red-100 text-red-800': ragStatus === 'loading',
                                'bg-green-100 text-green-800': ragStatus === 'ready',
                                'bg-gray-100 text-gray-800': ragStatus === 'error'
                            }"
                            x-text="ragStatus === 'loading' ? 'Caricamento...' : ragStatus === 'ready' ? 'Pronto' : 'Errore'"
                        ></span>
                    </div>
                    
                    <!-- Documents Status -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Doc:</span>
                        <span 
                            class="px-2 py-1 text-xs rounded-full"
                            :class="{
                                'bg-green-100 text-green-800': documentsCount > 0,
                                'bg-gray-100 text-gray-800': documentsCount === 0
                            }"
                            x-text="documentsCount + ' documenti'"
                        ></span>
                    </div>
                    
                    <!-- Query Status -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Query:</span>
                        <span 
                            class="px-2 py-1 text-xs rounded-full"
                            :class="{
                                'bg-yellow-100 text-yellow-800': queryStatus === 'processing',
                                'bg-green-100 text-green-800': queryStatus === 'ready',
                                'bg-red-100 text-red-800': queryStatus === 'error',
                                'bg-gray-100 text-gray-800': queryStatus === 'idle'
                            }"
                            x-text="queryStatus === 'processing' ? 'Elaborazione...' : queryStatus === 'ready' ? 'Pronto' : queryStatus === 'error' ? 'Errore' : 'In attesa'"
                        ></span>
                    </div>
                </div>
                
                <!-- Theme Toggle -->
                <button 
                    @click="toggleTheme()" 
                    class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600"
                    x-text="theme === 'dark' ? 'ðŸŒž' : 'ðŸŒ™'"
                ></button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Sidebar - Document Management -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Document Management</h2>
                    
                    <!-- STATELESS Info -->
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="text-sm text-blue-800">
                                <p class="font-medium">Stateless App</p>
                                <p class="text-blue-700">Documents are kept only for this session. When the app is closed, they will be automatically removed.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Section -->
                    <div class="mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Upload Document</h3>
                        
                        <!-- Upload Form -->
                        <form 
                            hx-post="/api/v1/documents/" 
                            hx-encoding="multipart/form-data"
                            hx-target="#upload-result"
                            hx-swap="innerHTML"
                            class="space-y-3"
                        >
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 transition-colors">
                                <input 
                                    type="file" 
                                    name="file" 
                                    accept=".pdf"
                                    class="hidden" 
                                    id="file-input"
                                    @change="handleFileSelect($event)"
                                >
                                <label for="file-input" class="cursor-pointer">
                                    <div class="text-gray-600">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-1 text-sm">Click to upload PDF</p>
                                        <p class="text-xs text-gray-500">or drag and drop</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div x-show="selectedFile" class="text-sm text-gray-600">
                                Selected: <span x-text="selectedFile ? selectedFile.name : ''"></span>
                            </div>
                            
                            <input 
                                type="text" 
                                name="title" 
                                placeholder="Document title (optional)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                            
                            <textarea 
                                name="description" 
                                placeholder="Description (optional)"
                                rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            ></textarea>
                            
                            <input 
                                type="text" 
                                name="tags" 
                                placeholder="Tags (comma-separated)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                            
                            <button 
                                type="submit"
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 flex items-center justify-center"
                                :disabled="uploading || !selectedFile"
                                id="upload-btn"
                            >
                                <svg x-show="uploading" class="animate-spin h-5 w-5 mr-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;" id="upload-spinner">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                                </svg>
                                <span>Upload Document</span>
                            </button>
                        </form>
                        
                        <!-- Upload Result -->
                        <div id="upload-result" class="mt-3"></div>
                    </div>
                    
                    <!-- Document List -->
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Documents</h3>
                        <div class="mb-2 text-xs text-blue-600">
                            The list only shows documents uploaded in this session. After a refresh or restart, search will still work on temporary files.
                        </div>
                        <div 
                            hx-get="/api/v1/documents/" 
                            hx-trigger="loadDocuments from:body, documentUploaded from:body"
                            hx-target="#document-list"
                            hx-swap="innerHTML"
                            hx-headers='{"HX-Request": "true"}'
                        >
                        </div>
                        <div id="document-list">
                            <!-- Fallback message when no documents -->
                        </div>
                        <button 
                            class="mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                            :disabled="uploading"
                            @click="resetDocuments"
                            id="reset-btn"
                        >
                            Clear documents
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content - Query Interface -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Query Documents</h2>
                    
                    <!-- Query Form -->
                    <form 
                        hx-post="/api/v1/queries/" 
                        hx-target="#query-result"
                        hx-swap="innerHTML"
                        class="space-y-4"
                    >
                        <div>
                            <label for="query" class="block text-sm font-medium text-gray-700 mb-2">Your Question</label>
                            <textarea 
                                id="query"
                                name="query" 
                                rows="3"
                                placeholder="Ask a question about your documents..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                            ></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="top_k" class="block text-sm font-medium text-gray-700 mb-1">Results</label>
                                <input 
                                    type="number" 
                                    id="top_k"
                                    name="top_k" 
                                    value="5" 
                                    min="1" 
                                    max="20"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                            </div>
                            <div>
                                <label for="similarity_threshold" class="block text-sm font-medium text-gray-700 mb-1">Similarity</label>
                                <input 
                                    type="number" 
                                    id="similarity_threshold"
                                    name="similarity_threshold" 
                                    value="0.7" 
                                    min="0" 
                                    max="1" 
                                    step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                            </div>
                        </div>
                        
                        <button 
                            type="submit"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                            Ask Question
                        </button>
                    </form>
                    
                    <!-- Query Result -->
                    <div id="query-result" class="mt-6"></div>
                    <script>
                    document.body.addEventListener('htmx:afterOnLoad', function(evt) {
                        if (evt.detail.elt && evt.detail.elt.id === 'query-result') {
                            let answer = null;
                            try {
                                const data = JSON.parse(evt.detail.xhr.responseText);
                                if (data && data.answer) answer = data.answer;
                            } catch (e) {
                                // Provo a estrarre answer anche se ci sono caratteri di escape
                                const match = evt.detail.xhr.responseText.match(/"answer"\s*:\s*"([\s\S]*?)"\s*,/);
                                if (match && match[1]) answer = match[1].replace(/\\n/g, '\n').replace(/\\"/g, '"');
                            }
                            if (answer) {
                                evt.detail.elt.innerHTML = `<div class='bg-green-50 border border-green-200 rounded p-4 text-green-900 whitespace-pre-line'>${answer}</div>`;
                            } else {
                                evt.detail.elt.innerHTML = `<div class='bg-red-50 border border-red-200 rounded p-4 text-red-900'>${evt.detail.xhr.responseText}</div>`;
                            }
                        }
                    });
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js App -->
    <script>
        function ragApp() {
            return {
                theme: localStorage.getItem('theme') || 'light',
                selectedFile: null,
                ragStatus: 'idle', // 'loading', 'ready', 'error'
                documentsCount: 0,
                queryStatus: 'idle', // 'processing', 'ready', 'error', 'idle'
                uploading: false,
                
                init() {
                    this.applyTheme();
                    this.updateStatus(); // Initial status update
                    this.loadDocuments(); // Initial document list load
                    this.startStatusUpdates(); // Start periodic status updates
                },
                
                toggleTheme() {
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('theme', this.theme);
                    this.applyTheme();
                },
                
                applyTheme() {
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectedFile = file;
                    }
                },
                
                updateStatus() {
                    // Load system status every 5 seconds
                    fetch('/api/v1/health/status')
                        .then(response => response.json())
                        .then(data => {
                            this.ragStatus = data.rag_status;
                            this.documentsCount = data.documents_count;
                        })
                        .catch(error => {
                            console.error('Status update failed:', error);
                            this.ragStatus = 'error';
                        });
                },
                
                loadDocuments() {
                    // Trigger document list load
                    htmx.trigger(document.body, 'loadDocuments');
                },
                
                updateRagDocsCount() {
                    fetch('/api/v1/documents/')
                        .then(response => response.json())
                        .then(data => {
                            this.documentsCount = data.total;
                        })
                        .catch(error => {
                            console.error('Documents count update failed:', error);
                            this.documentsCount = 0;
                        });
                },
                
                startStatusUpdates() {
                    // Update status every 5 seconds
                    setInterval(() => {
                        this.updateStatus();
                        this.updateRagDocsCount();
                    }, 5000);
                },

                resetDocuments() {
                    if (confirm('Are you sure you want to clear the document list? This action is irreversible.')) {
                        fetch('/api/v1/documents/reset', {method: 'POST'})
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'ok') {
                                    alert('Documents cleared successfully!');
                                    htmx.trigger(document.body, 'documentUploaded'); // Trigger document list refresh
                                    htmx.trigger(document.body, 'loadDocuments'); // Trigger document list load
                                    this.updateRagDocsCount(); // Aggiorna il badge documenti
                                } else {
                                    alert('Error clearing documents.');
                                }
                            })
                            .catch(error => {
                                console.error('Error clearing documents:', error);
                                alert('Error clearing documents.');
                            });
                    }
                }
            }
        }
        
        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.status === 200) {
                // Clear form on successful upload
                if (evt.detail.elt.getAttribute('hx-post')?.includes('/documents/')) {
                    evt.detail.elt.reset();
                    document.getElementById('file-input').value = '';
                    // Trigger document list refresh
                    htmx.trigger(document.body, 'documentUploaded');
                    // Update status
                    setTimeout(() => {
                        htmx.trigger(document.body, 'loadDocuments');
                        ragApp().updateRagDocsCount(); // Aggiorna il badge documenti dopo upload
                    }, 1000);
                }
                
                // Update query status
                if (evt.detail.elt.getAttribute('hx-post')?.includes('/queries/')) {
                    // Query completed successfully
                    htmx.trigger(document.body, 'queryCompleted');
                }
            } else {
                // Handle errors
                if (evt.detail.elt.getAttribute('hx-post')?.includes('/documents/')) {
                    htmx.trigger(document.body, 'documentError');
                }
                if (evt.detail.elt.getAttribute('hx-post')?.includes('/queries/')) {
                    htmx.trigger(document.body, 'queryError');
                }
            }
        });
        
        // HTMX event handlers for status updates
        document.body.addEventListener('ragStatusUpdated', function(evt) {
            ragApp().ragStatus = evt.detail.status;
        });
        
        document.body.addEventListener('documentsCountUpdated', function(evt) {
            ragApp().documentsCount = evt.detail.count;
        });
        
        document.body.addEventListener('queryStatusUpdated', function(evt) {
            ragApp().queryStatus = evt.detail.status;
        });
        
        // Query status handlers
        document.body.addEventListener('queryCompleted', function(evt) {
            ragApp().queryStatus = 'ready';
            document.getElementById('query-result').innerHTML = '<div class="text-green-700">Answer received!</div>' + document.getElementById('query-result').innerHTML;
        });
        
        document.body.addEventListener('queryError', function(evt) {
            ragApp().queryStatus = 'error';
            document.getElementById('query-result').innerHTML = '<div class="text-red-700">Error during answer!</div>';
        });
        
        // Quando parte la query
        document.querySelector('form[hx-post="/api/v1/queries/"]').addEventListener('submit', function(evt) {
            ragApp().queryStatus = 'processing';
            document.getElementById('query-result').innerHTML = '<div class="text-blue-700">Question sent, waiting for answer...</div>';
        });
        
        // Document status handlers
        document.body.addEventListener('documentError', function(evt) {
            // Could add document-specific error handling here
        });

        // Quando parte l'upload documento
        document.querySelector('form[hx-post="/api/v1/documents/"]').addEventListener('submit', function(evt) {
            ragApp().uploading = true;
            document.getElementById('upload-spinner').style.display = '';
            document.getElementById('upload-btn').setAttribute('disabled', 'disabled');
            document.getElementById('reset-btn').setAttribute('disabled', 'disabled');
        });
        // Quando upload completato
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.elt.getAttribute('hx-post')?.includes('/documents/')) {
                ragApp().uploading = false;
                document.getElementById('upload-spinner').style.display = 'none';
                document.getElementById('upload-btn').removeAttribute('disabled');
                document.getElementById('reset-btn').removeAttribute('disabled');
            }
        });
    </script>
</body>
</html> 